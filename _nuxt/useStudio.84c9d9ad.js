import{a4 as L,ad as N,L as U,ap as O,aq as R,ar as S,m as T,as as b,ao as k,J as A}from"./entry.319287c6.js";import J from"./ContentPreviewMode.d229ad76.js";/* empty css                               */const j=(p,r,v)=>{const f=[...r||[]],s=[...v||[]],n=[...p||[]];for(const e of f)if(e.oldPath)if(s.splice(s.findIndex(a=>a.path===e.oldPath),1),f.find(a=>a.path===e.oldPath))n.push({path:e.path,parsed:e.parsed});else{const a=n.find(d=>d.path===e.oldPath);a&&(a.path=e.path,e.parsed?a.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(d=>{a.parsed[d]=e.pathMeta[d]}))}else if(e.new)n.push({path:e.path,parsed:e.parsed});else{const c=n.find(a=>a.path===e.path);c&&Object.assign(c,{path:e.path,parsed:e.parsed})}for(const e of s)n.splice(n.findIndex(c=>c.path===e.path),1);return n},F=p=>{let r;return(...v)=>(r||(r=p()),r)},E=F(()=>JSON.parse(JSON.stringify(A()))),q=()=>{var P,C,I,$;const p=L(),r=N().public.studio||{},v=E();let f;const s=($=(I=(C=(P=p==null?void 0:p.vueApp)==null?void 0:P._context)==null?void 0:C.config)==null?void 0:I.globalProperties)==null?void 0:$.$pinceauTheme,n=U("client-db",()=>null),e=O("previewToken",{sameSite:"none",secure:!0}),c=async(t,i,o=!0)=>{const h=await t.getKeys(`${e.value}:`);await Promise.all(h.map(l=>t.removeItem(l))),await t.setItem(`${e.value}$`,JSON.stringify({ignoreBuiltContents:o})),await Promise.all(i.map(l=>{var m;return t.setItem(`${e.value}:${(m=l.parsed)==null?void 0:m._id}`,JSON.stringify(l.parsed))}))},a=t=>{R(p,S,[t||v])},d=t=>{!s||!(s!=null&&s.updateTheme)||(f||(f=JSON.parse(JSON.stringify((s==null?void 0:s.theme.value)||{}))),R(p,s.updateTheme,[t||f]))},w=async t=>{const i=await $fetch("api/projects/preview",{baseURL:r.apiURL,params:{token:e.value}}),o=j(i.files,i.additions,i.deletions),h=o.filter(u=>u.path.startsWith("content"));await c(t,h,(i.files||[]).length!==0);const l=o.filter(u=>u.path.startsWith(".studio")),m=l.find(u=>u.path===".studio/app.config.json");a(m==null?void 0:m.parsed);const g=l.find(u=>u.path===".studio/tokens.config.json");d(g==null?void 0:g.parsed)},y=async()=>{await $fetch("api/projects/preview/sync",{baseURL:r.apiURL,method:"POST",params:{token:e.value}})},_=t=>{const i=T(()=>!!t.value),o=document.createElement("div");o.id="__nuxt_preview_wrapper",document.body.appendChild(o),b(J,{previewToken:e,apiURL:r.apiURL,storageReady:i,refresh:()=>w(t.value).then(()=>k()),init:y}).mount(o)},x=async t=>{var o,h;if(!t)return null;t=t.replace(/\/$/,"");let i=await((o=n.value)==null?void 0:o.getItem(`${e.value}:${t}`));return i||(i=await((h=n.value)==null?void 0:h.getItem(t))),i};return{apiURL:r.apiURL,previewToken:e,contentStorage:n,syncPreview:w,syncPreviewFiles:c,syncPreviewAppConfig:a,syncPreviewTokensConfig:d,requestPreviewSynchronization:y,mountPreviewUI:_,findContentWithId:x}};export{q as useStudio};
